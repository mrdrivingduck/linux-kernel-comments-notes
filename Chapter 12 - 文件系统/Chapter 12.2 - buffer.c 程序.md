# Chapter 12.2 - buffer.c ç¨‹åº

Created by : Mr Dk.

2019 / 09 / 02 0:46

Ningbo, Zhejiang, China

---

## 12.2 buffer.c ç¨‹åº

é«˜é€Ÿç¼“å†²ç®¡ç†ç¨‹åº

### 12.2.1 åŠŸèƒ½æè¿°

#### 1. é«˜é€Ÿç¼“å†²åŒºçš„ç‰©ç†ä½ç½®

é«˜é€Ÿç¼“å†²åŒºä½äº __å†…æ ¸ä»£ç __ å’Œ __ä¸»å†…å­˜åŒº__ ä¹‹é—´

é™¤äº† __å—è®¾å¤‡é©±åŠ¨ç¨‹åº__

å†…æ ¸ç¨‹åºå¦‚æœéœ€è¦è®¿é—®å—è®¾å¤‡ä¸­çš„æ•°æ®

éƒ½éœ€è¦ç»è¿‡é«˜é€Ÿç¼“å†²åŒºæ¥é—´æ¥åœ°è¿›è¡Œæ“ä½œ

#### 2. é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–

åœ¨åˆå§‹åŒ–æ—¶ï¼Œé«˜é€Ÿç¼“å†²åŒºè¢«åˆ’åˆ†ä¸º 1024B å¤§å°çš„ç¼“å†²å—

ä»æ•´ä¸ªç¼“å†²åŒºä¸¤ç«¯å¼€å§‹ï¼Œåˆ†åˆ«åŒæ—¶è®¾ç½® __ç¼“å†²å—å¤´ç»“æ„__ å’Œ __ç¼“å†²å—__

* åœ°å€é«˜ç«¯è¢«åˆ’åˆ†ä¸º 1024B çš„ç¼“å†²å—
* åœ°å€ä½ç«¯åˆ†åˆ«å»ºç«‹èµ·å¯¹åº”å„å¤´ç»“æ„çš„ `buffer_head`

æŒç»­åˆ°ç¼“å†²åŒºæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å†åˆ’åˆ†å‡ºç¼“å†²å—ä¸ºæ­¢

![12-16](../img/12-16.png)

#### 3. é«˜é€Ÿç¼“å†²åŒºç»“æ„å’Œé“¾è¡¨

buffer_head çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```c
struct buffer_head {
    char * b_data; // æŒ‡å‘å¯¹åº”ç¼“å†²å—
    unsigned long b_blocknr; // å—å·
    unsigned short b_dev; // è®¾å¤‡å· (0 ä»£è¡¨ç©ºé—²)
    unsigned char b_uptodate; // æ•°æ®æ˜¯å¦å·²æ›´æ–°
    unsigned char b_dirt; // æ•°æ®æ˜¯å¦å·²ä¿®æ”¹
    unsigned char b_count; // ä½¿ç”¨è¯¥å—çš„å¼•ç”¨æ•°
    unsigned char b_lock; // ç¼“å†²åŒºæ˜¯å¦è¢«é”å®š
    struct task_struct * b_wait; // ç­‰å¾…è¯¥ç¼“å†²åŒºè§£é”çš„ä»»åŠ¡
    struct buffer_head * b_prev; // hash é˜Ÿåˆ—æ­£å‘æŒ‡é’ˆ
    struct buffer_head * b_next; // hash é˜Ÿåˆ—åå‘æŒ‡é’ˆ
    struct buffer_head * b_prev_free; // ç©ºé—²é“¾è¡¨æ­£å‘æŒ‡é’ˆ
    struct buffer_head * b_next_free; // ç©ºé—²é“¾è¡¨åå‘æŒ‡é’ˆ
};
```

æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»å¦‚å›¾ï¼š

![12-17](../img/12-17.png)

æ‰€æœ‰ç¼“å†²å—çš„ buffer_head è¢«é“¾æ¥æˆä¸€ä¸ª __åŒå‘é“¾è¡¨__ ç»“æ„ - ç§°ä¸º __ç©ºé—²é“¾è¡¨__

* ç”± `b_prev_free` å’Œ `b_next_free` é“¾æ¥
* å®é™…ä¸Šæ˜¯ä¸€ä¸ª LRU (Least Recently Used) é“¾è¡¨

> ä½†æ˜¯ç©ºé—²é“¾è¡¨ä¸­çš„é¡¹å¹¶ä¸éƒ½æ˜¯ç©ºé—²çš„... ğŸ¤¨

`free_list` æŒ‡é’ˆæ˜¯é“¾è¡¨çš„å¤´æŒ‡é’ˆï¼ŒæŒ‡å‘è¿‘æœŸæœ€å°‘ä½¿ç”¨çš„ç¼“å†²å—

è¯¥ç¼“å†²å—çš„åå‘æŒ‡é’ˆæŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªç¼“å†²å—ï¼Œå³æœ€è¿‘åˆšä½¿ç”¨çš„ç¼“å†²å—

`b_lock` æ˜¯é”å®šæ ‡å¿— - è¡¨ç¤º __é©±åŠ¨ç¨‹åº__ æ­£åœ¨å¯¹è¯¥ç¼“å†²å—çš„å†…å®¹è¿›è¡Œä¿®æ”¹

* æ›´æ–°æ•°æ®å—ä¿¡æ¯æ—¶ï¼Œå½“å‰è¿›ç¨‹ä¼šè‡ªæ„¿ç¡çœ ç­‰å¾…ï¼Œåˆ«çš„è¿›ç¨‹æœ‰æœºä¼šè®¿é—®è¯¥ç¼“å†²å—
* åº”å½“åœ¨ç¡çœ ä¹‹å‰é”å®šè¯¥ç¼“å†²å—

`b_count` è¡¨ç¤ºç›¸åº”ç¼“å†²å—è¢«å„ä¸ªè¿›ç¨‹å¼•ç”¨çš„æ¬¡æ•°

* è®¡æ•°ä¸ä¸º 0 æ—¶ï¼Œå°±ä¸èƒ½é‡Šæ”¾ç›¸åº”ç¼“å†²å—
* è®¡æ•°ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºè¯¥ç¼“å†²å—ç©ºé—²
* å¯¹äºç¨‹åºç”³è¯·çš„ç¼“å†²å—ï¼Œå¦‚æœåœ¨ hash è¡¨ä¸­å·²ç»å­˜åœ¨è¯¥å—ï¼Œåˆ™ç›´æ¥å°† b_count åŠ  1
* å¦åˆ™é‡æ–°ç”³è¯·ä¸€å—ç©ºé—²ç¼“å†²å—ï¼Œå¹¶å°† b_count è®¾å¤‡ä¸º 1
* ç¨‹åºé‡Šæ”¾å¯¹ç¼“å†²å—çš„å¼•ç”¨æ—¶ï¼Œb_count å‡ 1

`b_dirt` æ˜¯ __è„__ æ ‡å¿— - è¯´æ˜ç¼“å†²å—ä¸­çš„å†…å®¹å·²è¢«ä¿®æ”¹ï¼Œä¸å—è®¾å¤‡ä¸Šå¯¹åº”å†…å®¹ä¸åŒ

`b_uptodate` æ˜¯æ•°æ®æœ‰æ•ˆæ ‡å¿— - è¯´æ˜ç¼“å†²å—ä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ

* åˆå§‹åŒ–æˆ–é‡Šæ”¾å—æ—¶ï¼Œ`b_dirt` å’Œ `b_uptodate` éƒ½åº”è®¾ç½®ä¸º 0

#### 4. é«˜é€Ÿç¼“å†²åŒºçš„ hash è¡¨

ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿæœ‰æ•ˆåœ°åœ¨ç¼“å†²åŒºä¸­åˆ¤æ–­ __è¯·æ±‚çš„æ•°æ®å—æ˜¯å¦åœ¨ç¼“å†²åŒºä¸­__

* ä½¿ç”¨äº†å…·æœ‰ 307 ä¸ª buffer_header æŒ‡é’ˆé¡¹çš„ hash è¡¨
* ç”± `b_prev` å’Œ `b_next` é“¾æ¥

Hash å‡½æ•°ï¼š`(è®¾å¤‡å· ^ é€»è¾‘å—å·) mod 307`

* å°†å…·æœ‰ç›¸åŒ hash çš„ç¼“å†²å—é“¾æ¥åœ¨ hash è¡¨çš„åŒä¸€é¡¹ä¸Š

æ•°æ®ç»“æ„å…³ç³»çš„ç¤ºæ„ï¼š

![12-19](../img/12-19.png)

å®çº¿ä¸º hash è¡¨æŒ‡é’ˆï¼Œè™šçº¿ä¸ºä¹‹å‰æ‰€è°“çš„ç©ºé—²é“¾è¡¨æŒ‡é’ˆ

#### 5. ç¼“å†²å—æœç´¢å‡½æ•°

é¦–å…ˆåœ¨ hash è¡¨æŸé¡¹çš„é˜Ÿåˆ—ä¸­æœç´¢æŒ‡å®š __è®¾å¤‡å·__ å’Œ __é€»è¾‘å—å·__ çš„ç¼“å†²å—æ˜¯å¦å·²å­˜åœ¨

è‹¥å­˜åœ¨ï¼Œåˆ™ä¹‹é—´è¿”å› buffer_head æŒ‡é’ˆ

è‹¥ä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç©ºé—²é“¾è¡¨çš„å¤´éƒ¨å¼€å§‹ï¼Œå¯»æ‰¾ä¸€ä¸ªç©ºé—²çš„ç¼“å†²å—

* å…¶ä¸­è¿˜éœ€è¦å¯¹æ‰¾åˆ°çš„ç©ºé—²ç¼“å†²å—ä½œæ¯”è¾ƒ - å“ªä¸ªæ¯”è¾ƒé€‚åˆï¼Ÿ
* æƒå€¼ - ç”± __é”å®šæ ‡å¿—__ å’Œ __ä¿®æ”¹æ ‡å¿—__ è®¡ç®—

è‹¥æ²¡æœ‰æ‰¾åˆ°ç©ºé—²å—ï¼Œåˆ™è¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œé†’æ¥äº†å†æ¥ç€æ‰¾

è‹¥ç©ºé—²å—è¢«é”å®šï¼Œåˆ™è¿›ç¨‹ä¹Ÿè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…é©±åŠ¨ç¨‹åºå¯¹å…¶è§£é”

* è‹¥ä»ç¡çœ åˆ°é†’æ¥ç»§ç»­æ‰§è¡Œä¹‹é—´çš„æ—¶é—´é‡Œï¼Œè¯¥å—è¢«å…¶å®ƒè¿›ç¨‹å ç”¨ï¼Œåˆ™éœ€è¦é‡æ–°å¼€å§‹æœç´¢

å¦‚æœè¯¥ç¼“å†²å—å·²è¢«ä¿®æ”¹è¿‡ï¼Œåˆ™éœ€è¦å°†ç¼“å†²å—ä¸ç¡¬ç›˜åŒæ­¥ - å†™ç›˜

* å†æ¬¡ç­‰å¾…è¯¥å—è§£é”
* å¦‚æœè¯¥å—åˆè¢«å…¶å®ƒè¿›ç¨‹å ç”¨ï¼Œåˆ™åˆå‰åŠŸå°½å¼ƒï¼Œéœ€è¦é‡æ–°å¼€å§‹æœç´¢

å¦‚æœï¼Œåœ¨å½“å‰è¿›ç¨‹ç¡çœ æ—¶ï¼Œå…¶å®ƒè¿›ç¨‹å·²ç»å°†æˆ‘ä»¬éœ€è¦çš„ç¼“å†²å—åŠ å…¥äº† hash é˜Ÿåˆ—ä¸­

* å› æ­¤è¿˜éœ€è¦æœç´¢ä¸€ä¸‹ hash é˜Ÿåˆ—ï¼Œåˆéœ€è¦é‡æ–°æ‰§è¡Œ

æœ€ç»ˆï¼Œæ‰¾åˆ°äº†ä¸€å— __æœªè¢«è¿›ç¨‹ä½¿ç”¨ã€æ²¡ä¸Šé”ã€æ²¡è¢«ä¿®æ”¹__ çš„ç©ºé—²å—

* å°†è¯¥å—çš„å¼•ç”¨æ¬¡æ•°ç½® 1
* å¤ä½å…¶å®ƒå‡ ä¸ªæ ‡å¿—
* ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤è¯¥å—ï¼Œè®¾ç½® __è®¾å¤‡å·__ å’Œ __é€»è¾‘å—å·__ å
* æ’å…¥ hash è¡¨å¯¹åº”é¡¹çš„å¤´éƒ¨
* é“¾æ¥åˆ°ç©ºé—²é“¾è¡¨çš„æœ«å°¾å¤„

ç”±äºæ“ä½œæ˜¯ä»ç©ºé—²é“¾è¡¨çš„å¤´éƒ¨å¼€å§‹æœç´¢ï¼Œç§»é™¤æœ€è¿‘æœ€ä¸å¸¸ç”¨çš„å—åï¼Œæ’å…¥å°¾éƒ¨

å› æ­¤å®ç°äº† LRU ç®—æ³•

ç®—æ³•ç­–ç•¥ï¼š

* ç¼“å†²å—å·²åœ¨ hash è¡¨ä¸­ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
* ä»ç©ºé—²é“¾è¡¨å¤´éƒ¨å¼€å§‹æœç´¢æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å†²å—å¹¶ä½¿ç”¨
* ä¼˜å…ˆçº§
  * æ ¹æ® `b_dirt` å’Œ `b_lock` è®¡ç®—æƒé‡
  * ç”±äºå†™å…¥æ“ä½œè¾ƒä¸ºè€—æ—¶ï¼Œéœ€è¦åŠ åˆ° `b_dirt` çš„æƒé‡
  * åœ¨æƒé‡æœ€å°çš„ç¼“å†²å—ä¸Šç­‰å¾…

#### 6. ç¼“å†²å—è¯»å–å‡½æ•°

å–å¾—çš„ç¼“å†²å—å¯èƒ½æ˜¯ä¸€ä¸ªæ–°çš„ç©ºé—²å—

ä¹Ÿå¯èƒ½æ˜¯æ­£å¥½å«æœ‰éœ€è¦çš„æ•°æ®çš„ç¼“å†²å—

å› æ­¤è¦åˆ¤æ–­ç¼“å†²å—çš„ `b_uptodate` æŸ¥çœ‹ç¼“å†²å—æ•°æ®æ˜¯å¦æœ‰æ•ˆ

å¦‚æœæœ‰æ•ˆï¼Œåˆ™æ•°æ®å—å¯ä»¥ç›´æ¥è¢«è¿”å›ç»™ç”³è¯·ç¨‹åº

å¦åˆ™å°±è°ƒç”¨ __ä½å±‚å—è®¾å¤‡è¯»å†™å‡½æ•° ll_rw_block()__ ï¼Œå¹¶è®©è‡ªèº«è¿›å…¥ç¡çœ 

ç­‰å¾…æ•°æ®è¢«è¯»å…¥ç¼“å†²å—

é†’æ¥åå†åˆ¤æ–­æ•°æ®æ˜¯å¦å·²ç»æœ‰æ•ˆ

å¦‚æœæœ‰æ•ˆï¼Œåˆ™å¯ä»¥è¿”å›ç»™ç”³è¯·çš„ç¨‹åº

å¦åˆ™è¯»æ“ä½œå¤±è´¥ï¼Œäºæ˜¯é‡Šæ”¾ç¼“å†²å—ï¼Œå¹¶è¿”å› NULL

å½“ç¨‹åºä¸å†éœ€è¦ä½¿ç”¨ç¼“å†²å—ä¸­çš„æ•°æ®æ—¶

å°±é‡Šæ”¾ç¼“å†²å—ï¼Œå¹¶å”¤é†’å› ç­‰å¾…ç¼“å†²å—è€Œç¡çœ çš„è¿›ç¨‹

ç©ºé—²é“¾è¡¨ä¸­çš„ç¼“å†²å—ï¼Œåªæœ‰å½“ï¼š

* è¢«å†™ç›˜åˆ·æ–°
* è§£é”
* å¼•ç”¨è®¡æ•°ä¸º 0

æ‰èƒ½æŒªä½œä»–ç”¨

#### 7. é«˜é€Ÿç¼“å†²åŒºè®¿é—®è¿‡ç¨‹å’ŒåŒæ­¥æ“ä½œ

è®©å†…å­˜ä¸­çš„ä¸€äº›ç¼“å†²å—å†…å®¹ä¸ç£ç›˜å—è®¾å¤‡ä¸Šçš„ä¿¡æ¯ä¸€è‡´

* æ¯”å¦‚ `sync_inodes()` æ˜¯ä¸ºäº†æŠŠ inode_table ä¸­çš„ inode ä¿¡æ¯ä¸ç£ç›˜ä¸€è‡´èµ·æ¥

åŒæ­¥æ“ä½œé€šå¸¸è¢«åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

1. æ•°æ®ç»“æ„ä¿¡æ¯ä¸é«˜é€Ÿç¼“å†²åŒºä¸­ç¼“å†²å—çš„åŒæ­¥
2. é«˜é€Ÿç¼“å†²åŒºä¸­æ•°æ®å—ä¸ç£ç›˜å¯¹åº”å—çš„åŒæ­¥

### 12.2.2 ä»£ç æ³¨é‡Š

#### æŒ‡é’ˆå®šä¹‰

```c
extern int end; // å†…æ ¸ä»£ç æœ«ç«¯
struct buffer_head * start_buffer = (struct buffer_head *) &end;
struct buffer_head * hash_table[NR_HASH]; // NR_HASH = 307
static struct buffer_head * free_list; // ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆ
static struct task_struct * buffer_wait = NULL; // ç©ºé—²ç¼“å†²å—ç­‰å¾…é˜Ÿåˆ—

int NR_BUFFERS = 0; // ç³»ç»Ÿä¸­å«æœ‰çš„ç¼“å†²åŒºä¸ªæ•°
```

#### wait_on_buffer() - ç­‰å¾…æŒ‡å®šç¼“å†²åŒºè§£é”

å¦‚æœæŒ‡å®šçš„ç¼“å†²å—å·²ç»ä¸Šé”

åˆ™è®©è¿›ç¨‹ä¸å¯ä¸­æ–­åœ°ç­‰å¾…åœ¨ç¼“å†²å—çš„ç­‰å¾…é˜Ÿåˆ—ä¸­

ç¼“å†²å—è§£é”æ—¶ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹å°†è¢«å”¤é†’

å…¶ä¸­æ¶‰åŠåˆ°äº†å¼€ / å…³ä¸­æ–­ï¼š

* è™½ç„¶è¿›ç¨‹æ˜¯åœ¨å…³ä¸­æ–­ä¹‹åè¿›å…¥ä¼‘çœ çš„
* ä½†ç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ EFLAGSï¼Œä¿å­˜åœ¨ TSS æ®µä¸­
* å› æ­¤è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œå½“å‰ EFLAGS ä¹Ÿéšä¹‹æ”¹å˜

å³ - æ¯ä¸ªè¿›ç¨‹ä¸­æ–­çš„å¼€ / å…³çŠ¶æ€æ˜¯ç‹¬ç«‹çš„

```c
static inline void wait_on_buffer(struct buffer_head * bh)
{
    cli();
    while (bh->b_lock)
        sleep_on(&bh->b_wait);
    sti();
}
```

#### sys_sync() - åŒæ­¥è®¾å¤‡å’Œé«˜é€Ÿç¼“å†²ä¸­çš„æ•°æ®

é¦–å…ˆè°ƒç”¨ inode åŒæ­¥å‡½æ•°ï¼Œå°†å†…å­˜ä¸­æ‰€æœ‰ä¿®æ”¹è¿‡çš„ inode å†™å…¥é«˜é€Ÿç¼“å†²

ç„¶åæ‰«ææ•´ä¸ªé«˜é€Ÿç¼“å†²åŒºï¼Œå¯¹å·²ç»è¢«ä¿®æ”¹çš„ç¼“å†²å—ç”Ÿæˆå†™ç›˜è¯·æ±‚

```c
int sys_sync(void)
{
    int i;
    struct buffer_head * bh;
    
    sync_inodes();
    
    bh = start_buffer; // ç¼“å†²åŒºå¼€å§‹å¤„
    for (i = 0; i < NR_BUFFERS; i++) {
        wait_on_buffer(bh);
        if (bh->d_dirt)
            // ç¼“å†²å—å·²è¢«ä¿®æ”¹
            ll_rw_block(WRITE, bh); // è°ƒç”¨å—è®¾å¤‡é©±åŠ¨ç¨‹åº
    }
    return 0;
}
```

#### sync_dev() - å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œé«˜é€Ÿç¼“å†²æ•°æ®ä¸è®¾å¤‡ä¸Šæ•°æ®çš„åŒæ­¥æ“ä½œ

å…ˆæœç´¢æ‰€æœ‰çš„é«˜é€Ÿç¼“å†²å—

å¯¹æŒ‡å®šè®¾å¤‡ dev çš„ç¼“å†²å—ï¼Œè‹¥å…¶æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œåˆ™è¿›è¡ŒåŒæ­¥æ“ä½œ

ç„¶åå°†å†…å­˜ inode çš„æ•°æ®å†™å…¥é«˜é€Ÿç¼“å†²ä¸­ï¼Œå†å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œä¸€æ¬¡ç›¸åŒçš„åŒæ­¥æ“ä½œ

* é‡‡ç”¨ä¸¤è¾¹åŒæ­¥æ“ä½œæ˜¯ä¸ºäº†æé«˜å†…æ ¸æ‰§è¡Œæ•ˆç‡

```c
int sync_dev(int dev)
{
    int i;
    struct buffer_head * bh;
    
    // åŒæ­¥æŒ‡å®šè®¾å¤‡æ‰€æœ‰å·²ä¿®æ”¹ç¼“å†²å—
    bh = start_buffer;
    for (i = 0; i < NR_BUFFERS; i++, bh++) {
        if (bh->b_dev != dev)
            continue;
        wait_on_buffer(bh); // ç­‰å¾…ç¼“å†²åŒºè§£é”
        if (bh->b_dev == dev && bh->b_dirt)
            ll_rw_block(WRITE, bh);
    }
    
    sync_inodes(); // å°† inode å†™å…¥é«˜é€Ÿç¼“å†²
    
    bh = start_buffer;
    for (i = 0; i < NR_BUFFERS; i++, bh++) {
        if (bh->b_dev != dev)
            continue;
        wait_on_buffer(bh);
        if (bh->b_dev == dev && bh->b_dirt)
            ll_rw_block(WRITE, bh);
    }
    
    return 0;
}
```

#### invalidate_buffers() - ä½¿æŒ‡å®šè®¾å¤‡åœ¨é«˜é€Ÿç¼“å†²åŒºä¸­çš„æ•°æ®æ— æ•ˆ

å¯¹æŒ‡å®šè®¾å¤‡çš„ç¼“å†²å—å¤ä½ `b_uptodate` å’Œ `b_dirt` æ ‡å¿—

```c
void inline invalidate_buffers(int dev)
{
    int i;
    struct buffer_head * bh;
    
    bh = start_buffer;
    for (i = 0; i < NR_BUFFERS; i++, bh++) {
        if (bh->b_dev != dev)
            continue;
        wait_on_buffer(bh);
        if (bh->b_dev == dev)
            bh->b_uptodate = bh->b_dirt = 0;
    }
}
```

#### Hash è®¡ç®—ã€æŸ¥æ‰¾å®

```c
#define _hashfn(dev, block) (((unsigned) (dev^block)) % NR_HASH)
#define hash(dev, block) hash_table[_hashfn(dev, block)]
```

#### remove_from_queues() - ä» hash é˜Ÿåˆ—å’Œç©ºé—²é“¾è¡¨ä¸­ç§»èµ°ç¼“å†²å—

```c
static inline void remove_from_queues(struct buffer_head * bh)
{
    // ä» hash é˜Ÿåˆ—ä¸­ç§»é™¤ç¼“å†²å—
    if (bh->b_next)
        bh->b_next->b_prev = bh->b_prev;
    if (bh->b_prev)
        bh->b_prev->b_next = bh->b_next;
    // è¯¥ç¼“å†²å—æ˜¯ hash é˜Ÿåˆ—çš„ç¬¬ä¸€å—
    // éœ€è¦è®© hash è¡¨ä¸­çš„é¡¹æŒ‡å‘è¯¥é¡¹
    if (hash(bh->b_dev, bh->b_blocknr) == bh)
        hash(bh->b_dev, bh->b_blocknr) = bh->b_next;
    
    // ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤ç¼“å†²å—
    if (!(bh->b_prev_free) || !(bh->b_next_free))
        panic("Free block list corrupted");
    bh->b_prev_free->b_next_free = bh->b_next_free;
    bh->b_next_free->b_prev_free = bh->b_prev_free;
    // å¦‚æœç©ºé—²é“¾è¡¨å¤´æŒ‡å‘æœ¬ç¼“å†²å—
    // åˆ™æŒ‡å‘ä¸‹ä¸€ç¼“å†²å—
    if (free_list == bh)
        free_list = bh->b_next_free;
}
```

#### insert_into_queues() - å°†ç¼“å†²å—æ’å…¥ç©ºé—²é“¾è¡¨å°¾éƒ¨ï¼ŒåŒæ—¶æ”¾å…¥ hash é˜Ÿåˆ—ä¸­

```c
static inline void insert_into_queues(struct buffer_head * bh)
{
    // æ’å…¥ç©ºé—²é“¾è¡¨å°¾éƒ¨
    bh->b_next_free = free_list;
    bh->b_prev_free = free_list->b_prev_free;
    free_list->b_prev_free->b_next_free = bh;
    free_list->b_prev_free = bh;
    
    // æ”¾å…¥ hash é˜Ÿåˆ—
    bh->b_prev = NULL;
    bh->b_next = NULL;
    if (!bh->b_dev)
        return;
    bh->b_next = hash(bh->b_dev, bh->b_blocknr);
    hash(bh->b_dev, bh->b_blocknr) = bh;
    if (bh->b_next)
        bh->b_next->b_prev = bh;
}
```

#### find_buffer() - åˆ©ç”¨ hash è¡¨åœ¨é«˜é€Ÿç¼“å†²ä¸­å¯»æ‰¾ç»™å®šè®¾å¤‡å’ŒæŒ‡å®šå—å·çš„ç¼“å†²å—

```c
static struct buffer_head * find_buffer(int dev, int block)
{
    struct buffer_head * tmp;
    
    for (tmp = hash(dev, block); tmp != NULL; tmp = tmp->b_next)
        if (tmp->b_dev == dev && tmp->b_blocknr == block)
            return tmp;
    return NULL;
}
```

#### get_hash_table() - åˆ©ç”¨ hash è¡¨å¯»æ‰¾æŒ‡å®šç¼“å†²å—

è‹¥æ‰¾åˆ°ï¼Œåˆ™å¯¹ç¼“å†²å—ä¸Šé”ï¼Œå¹¶è¿”å›å—çš„å¤´æŒ‡é’ˆ

```c
struct buffer_head * get_hash_table(int dev, int block)
{
    struct buffer_head * bh;
    
    for (;;) {
        if (!(bh = find_buffer(dev, block)))
            // ç¼“å†²å—ä¸­æ²¡æœ‰
            return NULL;
        bh->b_count++; // å¢åŠ å¼•ç”¨æ¬¡æ•°
        wait_on_buffer(bh); // ç­‰å¾…è§£é”
        // ç¡çœ çŠ¶æ€åï¼Œéœ€è¦æ£€éªŒç¼“å†²å—çš„æ­£ç¡®æ€§
        if (bh->b_dev == dev && bh->b_blocknr == block)
            return bh;
        // ç¼“å†²å—çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ’¤é”€å¼•ç”¨ï¼Œé‡æ–°å¯»æ‰¾
        bh->b_count--;
    }
}
```

#### getblk() - å–é«˜é€Ÿç¼“å†²ä¸­æŒ‡å®šçš„ç¼“å†²å—

æ£€æŸ¥æŒ‡å®šè®¾å¤‡å·å’Œå—å·çš„ç¼“å†²å—æ˜¯å¦å·²åœ¨é«˜é€Ÿç¼“å†²ä¸­

å¦‚æœæ˜¯ï¼Œåˆ™è¿”å›å¯¹åº”çš„å¤´æŒ‡é’ˆ

å¦‚æœä¸æ˜¯ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªå¯¹åº”è®¾å¤‡å·å’Œå—å·çš„æ–°é¡¹ï¼Œå¹¶è¿”å›ç¼“å†²å—å¤´æŒ‡é’ˆ

é¦–å…ˆå®šä¹‰äº†åˆ¤æ–­ç¼“å†²å—æƒé‡çš„å®ï¼š

* ä¿®æ”¹æ ‡å¿—çš„æƒé‡è¾ƒé«˜

```c
#define BADNESS(bh) (((bh)->b_dirt<< 1)+(bh)->b_lock)
```

```c
struct buffer_head * getblk(int dev, int block)
{
    struct buffer_head * tmp, * bh;
    
repeat:
    if (bh = get_hash_table(dev, block))
        // ç¼“å†²åŒºå·²åœ¨é«˜é€Ÿç¼“å†²ä¸­
        return bh;
    
    // å¦åˆ™å°±å¼€å§‹æ‰«æç©ºé—²é“¾è¡¨
    tmp = free_list;
    do {
        if (tmp->b_count)
            // ç¼“å†²å—æ­£è¢«ä½¿ç”¨ï¼Œè·³è¿‡
            continue;
        if (!bh || BADNESS(tmp) < BADNESS(bh)) {
            bh = tmp;
            if (!BADNESS(tmp))
                // BADNESS == 0
                // æ²¡æœ‰é”å®šï¼Œæ²¡æœ‰ä¿®æ”¹çš„å—
                break;
        }
    } while ((tmp = tmp->b_next_free) != free_list);
    
    if (!bh) {
        // æ‰€æœ‰ç¼“å†²å—éƒ½è¢«ä½¿ç”¨ï¼Œåˆ™ç¡çœ ç­‰å¾…
        sleep_on(&buffer_wait);
        // å”¤é†’åé‡æ–°å¯»æ‰¾ç¼“å†²å—
        goto repeat;
    }
    
    // æ‰¾åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„ç©ºé—²ç¼“å†²å—
    
    wait_on_buffer(bh);
    if (bh->b_count)
        // å”¤é†’åè¯¥å—åˆè¢«å ç”¨äº†
        goto repeat;
    // ç¼“å†²åŒºå·²è¢«ä¿®æ”¹
    while (bh->b_dirt) {
        // æ•°æ®å†™ç›˜
        sync_dev(bh->b_dev);
        // å†æ¬¡ç­‰å¾…ç¼“å†²åŒºè§£é”
        wait_on_buffer(bh);
        if (bh->b_count)
            // åˆè¢«å ç”¨......
            goto repeat;
    }
    
    // ç¡çœ ç­‰å¾…çš„è¿‡ç¨‹ä¸­
    // å…¶å®ƒè¿›ç¨‹å¯èƒ½å·²ç»å°†è¯¥ç¼“å†²å—åŠ å…¥é«˜é€Ÿç¼“å†²ä¸­
    // å†æ¬¡æ£€æŸ¥
    if (find_buffer(dev, block))
        goto repeat;
    
    // å ç”¨ç¼“å†²å—
    bh->b_count = 1;
    bh->b_dirt = 0;
    bh->b_uptodate = 0;
    
    remove_from_queue(bh); // ç§»å‡ºç©ºé—²é“¾è¡¨
    bh->b_dev = dev;
    bh->b_blocknr = block;
    insert_into_queues(bh); // æ’å…¥åˆ°ç©ºé—²é“¾è¡¨å°¾éƒ¨
    return bh;
}
```

#### brelse() - é‡Šæ”¾æŒ‡å®šç¼“å†²å—

ç­‰å¾…ç¼“å†²å—è§£é”ï¼Œç„¶åå°†å¼•ç”¨è®¡æ•°é€’å‡ï¼Œæœ€åå”¤é†’ç­‰å¾…ç©ºé—²ç¼“å†²å—çš„è¿›ç¨‹

```c
void brelse(struct buffer_head * buf)
{
    if (!buf)
        return;
    wait_on_buffer(buf);
    if (!(buf->b_count--))
        panic("Trying to free free buffer");
    wake_up(&buffer_wait);
}
```

#### bread() - è¯»å–æŒ‡å®šæ•°æ®å—ï¼Œå¹¶è¿”å›å«æœ‰æ•°æ®çš„ç¼“å†²åŒº

æ ¹æ®è®¾å¤‡å·å’Œæ•°æ®å—å·

åœ¨é«˜é€Ÿç¼“å†²åŒºç”³è¯·ä¸€å—ç¼“å†²å—

è‹¥ç¼“å†²å—å·²å«æœ‰æœ‰æ•ˆçš„æ•°æ®ï¼Œå°±ç›´æ¥è¿”å›ç¼“å†²å—æŒ‡é’ˆ

å¦åˆ™è¯»å–æŒ‡å®šçš„æ•°æ®åˆ°ç¼“å†²å—ï¼Œå¹¶è¿”å›ç¼“å†²å—æŒ‡é’ˆ

```c
struct buffer_head * bread(int dev, int block)
{
    struct buffer_head * bh;
    
    if (!(bh = getblk(dev, block)))
        panic("bread: getblk returned NULL\n");
    if (bh->b_uptodate)
        // æ•°æ®æœ‰æ•ˆï¼Œå¯ç›´æ¥ä½¿ç”¨
        return bh;
    
    ll_rw_block(READ, bh); // äº§ç”Ÿè¯»å–å—è®¾å¤‡çš„è¯·æ±‚
    wait_on_buffer(bh); // ç­‰å¾…æ•°æ®è¢«è¯»å…¥ï¼Œç­‰å¾…ç¼“å†²åŒºè§£é”
    if (bh->b_uptodate)
        // ç¼“å†²åŒºå·²æ›´æ–°
        return bh;
    // è¯»è®¾å¤‡æ“ä½œå¤±è´¥ï¼Œé‡Šæ”¾ç¼“å†²åŒº
    brelse(bh);
    return NULL;
}
```

#### bread_page() - ä¸€æ¬¡è¯»å–å››ä¸ªç¼“å†²å—

åŒæ—¶è¯»å–å››å—å¯ä»¥è·å¾—é€Ÿåº¦ä¸Šçš„å¥½å¤„

å‚æ•°ä¸­çš„æ•°ç»„ `b[4]` åŒ…å«äº†å››ä¸ªè®¾å¤‡æ•°æ®å—å·

å¤åˆ¶å†…å­˜å—çš„å® - ä» from åœ°å€å¤åˆ¶ä¸€å— (1024B) åˆ° to ä½ç½®

```c
#define COPYBLK(from, to) \
__asm__("cld\n\t" \
    "rep\n\t" \
    "movsl\n\t" \
    ::"c"(BLOCK_SIZE/4), "S"(from), "D"(to) \
    :"cx", "di", "si")
```

```c
void bread_page(unsigned long address, int dev, int b[4])
{
    struct buffer_head * bh[4];
    int i;
    
    for (i = 0; i < 4; i++)
        if (b[i]) {
            if (bh[i] = getblk(dev, b[i]))
                // å–å¾—å¯¹åº”ç¼“å†²å—
                if (!bh[i]->b_updodate)
                    // å¦‚æœç¼“å†²å—ä¸­çš„æ•°æ®ä¸å¯ç”¨
                    // äº§ç”Ÿè¯»è®¾å¤‡è¯·æ±‚
                    ll_rw_block(READ, bh[i]);
        } else {
            bh[i] = NULL;
        }
    
    for (i = 0; i < 4; i++)
        if (bh[i]) {
            wait_on_buffer(bh[i]); // ç­‰å¾…ç¼“å†²åŒºè§£é”
            if (bh[i]->b_uptodate)
                // æ•°æ®æœ‰æ•ˆï¼Œå¤åˆ¶æ•°æ®
                COPYBLK((unsigned long) bh[i]->b_data, address);
            brelse(bh[i]); // é‡Šæ”¾ç¼“å†²åŒº
        }
}
```

#### breada() - ä»æŒ‡å®šè®¾å¤‡è¯»å–æŒ‡å®šçš„ä¸€äº›å—

å‡½æ•°å‚æ•°ä¸ªæ•°å¯å˜

æˆåŠŸæ—¶è¿”å›ç¬¬ä¸€å—çš„ buffer_head æŒ‡é’ˆï¼Œå¦åˆ™è¿”å› NULL

```c
struct buffer_head * breada(int dev, int first, ...)
{
    va_list args;
    struct buffer_head * bh, * tmp;
    
    va_start(args, first);
    if (!(bh = getblk(dev, first)))
        panic("bread: getblk returned NULL\n");
    if (!bh->b_uptodate)
        ll_rw_block(READ, bh);
    
    // é¢„è¯»éšåçš„æ•°æ®å—
    // åªéœ€è¯»è¿›é«˜é€Ÿç¼“å†²åŒºï¼Œå¹¶ä¸é©¬ä¸Šä½¿ç”¨
    // å› æ­¤è¯»å®Œåå°†å…¶å¼•ç”¨è®¡æ•°é€’å‡ï¼Œé‡Šæ”¾æ‰è¯¥å—
    while ((first = va_arg(args, int)) >= 0) {
        tmp = getblk(dev, first);
        if (tmp) {
            if (!tmp->b_uptodate)
                ll_rw_block(READA, tmp);
            tmp->b_count--;
        }
    }
    
    va_end(args);
    wait_on_buffer(bh); // ç­‰å¾…ç¬¬ä¸€ä¸ªç¼“å†²åŒºè§£é”
    if (bh->b_uptodate)
        // ç¼“å†²åŒºæ•°æ®æœ‰æ•ˆ
        return bh;
    // è¯»æ“ä½œå¤±è´¥ï¼Œé‡Šæ”¾ç¼“å†²åŒºï¼Œè¿”å› NULL
    brelse(bh);
    return (NULL);
}
```

#### buffer_init() - ç¼“å†²åŒºåˆå§‹åŒ–å‡½æ•°

ä»ç¼“å†²åŒºå¤´å’Œå°¾åˆ†åˆ«åˆå§‹åŒ– buffer_head å’Œå¯¹åº”çš„æ•°æ®å—

ç›´åˆ°ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å­˜éƒ½è¢«åˆ†é…å®Œæ¯•

```c
void buffer_init(long buffer_end)
{
    struct buffer_head * h = start_buffer;
    void * b;
    int i;
    
    // ç¡®å®šç¼“å†²åŒºé«˜ç«¯çš„å®é™…ä½ç½®
    if (buffer_end == 1 << 20)
        // ç¼“å†²åŒºé«˜ç«¯ç­‰äº 1MB
        // 640KB - 1MB è¢«æ˜¾å­˜å’Œ BIOS ä½¿ç”¨
        // å®é™…ç¼“å†²åŒºé«˜ç«¯åº”ä¸º 640KB
        b = (void *) (640*1024);
    else
        b = (void *) buffer_end;
    
    while ( (b -= BLOCK_SIZE) >= ((void *) (h + 1)) ) {
        h->b_dev = 0; // ç¼“å†²åŒºè®¾å¤‡å·
        h->b_dirt = 0;
        h->b_count = 0;
        h->b_lock = 0;
        h->b_uptodate = 0;
        h->b_wait = NULL;
        h->b_next = NULL;
        h->b_prev = NULL;
        h->b_data = (char *) b;
        h->b_prev_free = h-1;
        h->b_next_free = h+1;
        h++;
        NR_BUFFERS++;
        if (b == (void *) 0x100000)
            // b é€’å‡åˆ° 1MBï¼Œåˆ™è·³è¿‡ 384KB
            b = (void *) 0xA0000; // è®© b æŒ‡å‘ 640KB å¤„
    }
    
    h--; // h æŒ‡å‘æœ€åä¸€ä¸ªç¼“å†²å—å¤´
    free_list = start_buffer; // ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆ
    free_list->b_pref_free = h; // å¤´éƒ¨å’Œå°¾éƒ¨å…³è”å¾ªç¯
    h->b_next_free = free_list;
    
    // åˆå§‹åŒ–æ‰€æœ‰çš„ hash è¡¨é¡¹
    for (i = 0; i < NR_HASH; i++)
        hash_table[i] = NULL;
}
```

---

## Summary

è¿™é‡Œæ¶‰åŠåˆ°å¾ˆå¤šçš„ sleep å’Œ wake up

è¿›ç¨‹çŠ¶æ€çš„æ”¹å˜å’Œå¯¹å…¨å±€æ•°æ®ç»“æ„çš„æ“ä½œå°è£…åœ¨å­å‡½æ•°å†…

å¯¼è‡´ä»£ç å‘é«˜å±‚å°è£…çš„æ—¶å€™è¶Šæ¥è¶Šéš¾æ‡‚äº†...

çœ‹æ‡‚éƒ½å¾ˆéš¾äº†ï¼Œæ›´ä¸ç”¨æå¼€å‘çš„éš¾åº¦äº†..

è¿˜æ˜¯å¾ˆä½©æœçš„ ğŸ‘

---

